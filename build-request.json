{
  "kind": "build_request",
  "title": "Fix Internet Identity login flow — deep diagnosis and full rewrite",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-37",
      "text": "Perform a full rewrite of frontend/src/pages/LoginPage.tsx. The Sign In with Internet Identity button must: (1) never be disabled or have any condition preventing it from being clicked; (2) call the login() function from the useInternetIdentity hook on click; (3) display a visible loading spinner while isLoggingIn is true; (4) on successful authentication (identity becomes non-null / isAuthenticated becomes true), use TanStack Router's useNavigate to redirect to /dashboard (or /admin-dashboard, /manager-dashboard, /client-dashboard based on role if available); (5) display a user-visible inline error message if login() throws or authentication is cancelled. Remove every guard, disabled prop, or conditional render that could block the button before the actor is initialized.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "still not working, not able to login"
        ]
      },
      "acceptanceCriteria": [
        "Visiting the login page shows the Sign In with Internet Identity button in a clickable, enabled state immediately",
        "Clicking the button invokes the Internet Identity popup/flow without any error",
        "A spinner or loading indicator is visible while authentication is in progress",
        "After successful authentication, the user is automatically redirected to the appropriate dashboard route",
        "If the user cancels or authentication fails, an inline error message is shown on the login page",
        "No disabled prop, loading guard, or actor-initialization check blocks the button from being clickable"
      ]
    },
    {
      "id": "REQ-38",
      "text": "Rewrite frontend/src/components/bootstrap/BootstrapGate.tsx so it never blocks or visually disables the LoginPage UI. BootstrapGate must detect when the current route is the login page (or when the user is unauthenticated) and render children directly without any loading spinner, overlay, or disabled wrapper. The gate must only intercept navigation to authenticated/protected routes. Unauthenticated users must always see and interact with the full login UI regardless of actor or identity initialization state.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "still not working, not able to login"
        ]
      },
      "acceptanceCriteria": [
        "Opening the app when unauthenticated immediately renders the LoginPage with no loading spinner blocking it",
        "BootstrapGate does not render a spinner or error panel on the login route",
        "BootstrapGate still shows a loading state for authenticated users accessing protected routes before the actor is ready",
        "The Sign In button on LoginPage is interactable before the ICP actor has finished initializing"
      ]
    },
    {
      "id": "REQ-39",
      "text": "Audit and fix the useInternetIdentity hook integration in LoginPage. Ensure the hook is imported from the correct immutable path (frontend/src/hooks/useInternetIdentity.ts), that the destructured login function and isLoggingIn / isAuthenticated / identity values are correctly consumed, and that a useEffect watches isAuthenticated / identity to trigger role-based navigation after login resolves. If the hook returns a promise from login(), await it before checking authentication state. Confirm the InternetIdentityProvider is wrapping the app in frontend/src/main.tsx so the hook has access to its context.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "still not working, not able to login"
        ]
      },
      "acceptanceCriteria": [
        "No runtime errors about missing context or undefined hook values on the login page",
        "isLoggingIn correctly reflects true while the Internet Identity popup is open",
        "isAuthenticated transitions to true after the user completes authentication",
        "A useEffect in LoginPage triggers navigation once isAuthenticated is true",
        "InternetIdentityProvider is confirmed present in main.tsx wrapping the root app"
      ]
    },
    {
      "id": "REQ-40",
      "text": "Ensure role-based post-login redirect works correctly in LoginPage. After login() resolves and the user is authenticated, query the user's role from the backend actor (or from the existing useQueries hooks). Redirect admin users to /admin-dashboard, manager users to /manager-dashboard, client users to /client-dashboard, and any other authenticated user or unresolved role to /dashboard as the safe default. If the role query is still loading, redirect to /dashboard immediately rather than waiting indefinitely.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "still not working, not able to login"
        ]
      },
      "acceptanceCriteria": [
        "Admin users are redirected to /admin-dashboard after successful login",
        "Manager users are redirected to /manager-dashboard after successful login",
        "Client users are redirected to /client-dashboard after successful login",
        "Users with no determined role are redirected to /dashboard",
        "The redirect happens automatically without the user needing to click anything after authentication"
      ]
    }
  ],
  "constraints": [
    "Do not modify frontend/src/hooks/useInternetIdentity.ts or frontend/src/hooks/useInternetIdentity.tsx — these are immutable",
    "Do not modify frontend/src/main.tsx — this is immutable",
    "Do not modify any file under frontend/src/components/ui — these are immutable",
    "All Motoko logic must remain in backend/main.mo as a single actor"
  ],
  "nonGoals": [
    "Adding new authentication providers beyond Internet Identity",
    "Changing the visual design or branding of the login page beyond what is needed to fix the button",
    "Modifying any backend Motoko logic for this fix",
    "Changing any routes or pages other than LoginPage and BootstrapGate"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}